<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">

<dom-module id="build-view">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style">
            :host {
                display: block;
                width: 40%;
                height: 100%;
                text-align: center;
                padding-bottom: 32px;
            }

            paper-card {
                width: 100%;
                height: 100%;
            }

            .log {
                text-align: left;
                margin-left: 8px;
                margin-right: 8px;
            }

          #spinner {
            margin-left: auto;
            margin-right: auto;
            display: block;
          }

          .history {
            position: absolute;
            margin-left: 6px;
            margin-top: -2px;
          }

          #spinner {
            margin-top: 12px;
          }

          #logDialog {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 80%;
            right: 0;
            margin-left: auto;
            margin-right: auto;
          }

          .line {
            color: var(--primary-color);
          }

          .date {
            color: var(--secondary-color);
          }

          .text {
            word-break: break-all;
          }

          hr {
            opacity: var(--opacity);
          }

          .empty {
            opacity: var(--opacity);
          }
        </style>

        <h4>
            Build history

            <template is="dom-if" if="[[!started]]">
                <paper-spinner id="spinner" active></paper-spinner>
            </template>

            <template is="dom-if" if="[[started]]">
                <iron-icon on-click="_clear" class="history icon" icon="icons:clear"></iron-icon>
            </template>
        </h4>

        <template is="dom-repeat" items="{{builds}}" as="build">
            <template is="dom-if" if="{{_show(build)}}">
                <build-card on-click="_onClick" build="[[build]]"></build-card>
            </template>
        </template>

        <template is="dom-if" if="{{_isEmpty(builds)}}">
            <span class="empty">empty</span>
        </template>

        <paper-dialog id="logDialog" with-backdrop modal>
            <h2>[[build.message]]</h2>
            <paper-dialog-scrollable id="terminal" class="log">
                <paper-spinner id="spinner" active="[[loading]]"></paper-spinner>

                <template is="dom-repeat" items="{{log}}" as="event">
                        <span class="line">[{{_line()}}]</span>
                        <span class="date">[[_toDate(event.time)]]</span>
                        <span class="text">[[event.line]]</span>
                    <hr>
                </template>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss on-click="_close">Close</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax id="logLoader"
                   url="/api/?target=builds&route=log&id=[[build.id]]&offset=[[offset]]"
                   handle-as="json"
                   on-response="_onBuildLog" debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="clearBuilds" url="/api/?target=builds&route=clear"
                   handle-as="json" on-response="_onClear" debounce-duration="300">
        </iron-ajax>

    </template>
</dom-module>
<script>
    class BuildView extends Polymer.Element {

        static get is() {
            return 'build-view';
        }

        openDialog() {
            this.$.dialog.open();
        }

        constructor() {
            super();
            this.LOG_POLL = 2500;
            this.started = false;
            this.build = null;
            this.builds = [];
            this.log = [];

            setInterval(() => {
                if (this.build != null) {
                    this._reload();
                }
            }, this.LOG_POLL);
        }

        _onClear(event, request) {
            this.builds = request.response.list;
        }

        setBuilds(builds) {
            this.started = true;
            this.builds = builds;

            // update the build information after opening the log.
            if (this.build != null) {
                for (let i in builds) {
                    if (builds[i].id == this.build.id) {
                        this.build = builds[i];
                    }
                }
            }
        }

        _isEmpty() {
            return this.builds.length == 0;
        }

        _onClick(e) {
            this.loading = true;
            this.line = 0;
            this.offset = 0;
            this.build = e.model.build;
            this.log = [];
            this.$.logDialog.open();
            this._reload();
        }

        _toDate(epochMS) {
            return new Date(epochMS).toLocaleString();
        }

        _onBuildLog(event, request) {
            let events = request.response.collection;

            // on first load show all items at once.
            if (this.offset == 0) {
                this.log.push(...events);
                this._updateLog();
            } else {
                // delay each lines appearance by its timestamp plus the polling interval.
                // simulates real-time logging to screen.
                let current = this.build;
                for (let i in events) {
                    let event = events[i];
                    setTimeout(() => {
                        if (current.id == this.build.id) {
                            this.log.push(event);
                            this._updateLog();
                        }
                    }, this.LOG_POLL - (new Date().getTime() - event.time));
                }
            }

            if (events.length > 0) {
                this.offset = events[events.length -1].time;
            }
            this.loading = false;
        }

        _updateLog() {
            this.notifySplices('log');
            this.$.logDialog.notifyResize();
            setTimeout(() => {
                this.$.terminal.$.scrollable.scrollTop = Number.MAX_SAFE_INTEGER;
            }, 1);
        }

        _clear() {
            this.$.clearBuilds.generateRequest();
        }

        _reload() {
            this.$.logLoader.generateRequest();
        }

        _show(build) {
            return (build.progress != 'QUEUED')
        }

        _line() {
            return this.line++;
        }

        _close() {
            this.build = null;
        }
    }
    window.customElements.define(BuildView.is, BuildView);


</script>
