<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="build-card.html">
<link rel="import" href="shared-styles.html">

<dom-module id="build-stats">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style">
            :host {
                display: block;
                width: 100%;
                height: 128px;
                text-align: center;
            }

            paper-card {
                width: 100%;
                height: 100%;
            }

            .joke {
                font-size: 0.8em;
                opacity: 0.8;
            }

            .date {
                position: absolute;
                font-size: 0.8em;
                opacity: 0.8;
                top: 6px;
                right: 6px;
            }

            .config {
                position: absolute;
                top: 6px;
                left: 6px;
                color: var(--primary-color);
                cursor: pointer;
            }

            paper-item {
                cursor: pointer;
            }

            #config {
                text-align: left;
                width: 100%;
            }

            #config td, #config th {
                border: 1px solid rgba(255, 255, 255, 0.3);
                padding: 8px;
            }

            th {
                color: var(--primary-color);
            }

        </style>

        <paper-card elevation="1">
            <h4>Zapperfly build server 1.0.0</h4>

            <span class="joke">[[joke]]</span>
            <span class="date">[[time]]</span>

            <div class="config">
                <iron-icon on-click="_configure" class="icon" icon="icons:settings"></iron-icon>
                <iron-icon on-click="_about" class="icon" icon="icons:info-outline"></iron-icon>
            </div>

        </paper-card>

        <paper-dialog id="about" with-backdrop>
            <a target="_blank" href="https://github.com/codingchili/zapperfly-asm"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
            <h2>About</h2>
            <paper-dialog-scrollable style="margin-top:64px;">

                <a target="_blank" href="https://github.com/codingchili/zapperfly-asm"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

                <p>Zapperfly-asm is a clustered build server with minimal setup!</p>

                <p>Zapperfly is developed by Robin Duda, open source and available on github.</p>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button raised dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="configure" with-backdrop>
            <h2>Configuration</h2>
            <paper-dialog-scrollable>

                <span style="opacity:0.45">cluster-wide settings.</span>

                <table id="config">
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td>Cluster group</td>
                        <td>[[config.groupName]]</td>
                    </tr>
                    <tr>
                        <td>Webserver host</td>
                        <td>[[config.instanceName]]</td>
                    </tr>
                    <tr>
                        <td>Build timeout</td>
                        <td>[[config.timeoutSeconds]] seconds.</td>
                    </tr>
                    <tr>
                        <td>Build path</td>
                        <td>[[config.buildPath]]</td>
                    </tr>
                    <tr>
                        <td>Storage plugin</td>
                        <td>[[config.storage]]</td>
                    </tr>
                </table>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button raised dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax auto id="jokeLoader" url="https://api.icndb.com/jokes/random?limitTo=[nerdy]" handle-as="json"
                   on-response="_onJokes" debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="configLoader" url="/api/?target=config&route=cluster" handle-as="json"
                   on-response="_onConfig" debounce-duration="300">
        </iron-ajax>

    </template>
</dom-module>
<script>
    class BuildStats extends Polymer.Element {

        static get is() {
            return 'build-stats';
        }

        constructor() {
            super();

            this._updateTime();
            setInterval(() => {
                this._updateTime();
            }, 1000);

            setInterval(() => {
                this.$.jokeLoader.generateRequest();
            }, 10000);
        }

        _about() {
            this.$.about.open();
        }

        _configure() {
            this.$.configLoader.generateRequest();
            this.$.configure.open();
        }

        _updateTime() {
            this.time = new Date().toLocaleString();
        }

        _onJokes(event, request) {
            this.joke = request.response.value.joke;
        }

        _onConfig(event, request) {
            this.config = request.response;
        }
    }
    window.customElements.define(BuildStats.is, BuildStats);









</script>
