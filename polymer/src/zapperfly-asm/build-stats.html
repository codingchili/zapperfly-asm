<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="build-card.html">
<link rel="import" href="shared-styles.html">

<dom-module id="build-stats">
    <template>
        <style include="shared-styles"></style>
        <style is="custom-style">
            :host {
                display: block;
                width: 100%;
                height: 128px;
                text-align: center;
            }

            paper-card {
                width: 100%;
                height: 100%;
            }

            .joke {
                font-size: 0.8em;
                opacity: 0.8;
            }

            .date {
                position: absolute;
                font-size: 0.8em;
                opacity: 0.8;
                top: 6px;
                right: 6px;
            }

            .config {
                position: absolute;
                top: 6px;
                left: 6px;
                color: var(--primary-color);
                cursor: pointer;
            }

            paper-item {
                cursor: pointer;
            }

            #config {
                text-align: left;
                width: 100%;
            }

            #config td, #config th {
                border: 1px solid rgba(255, 255, 255, 0.3);
                padding: 8px;
            }

            th {
                color: var(--primary-color);
            }

            .icon {
                margin-left: 6px;
            }

            li {
                text-align: left;
            }

        </style>

        <paper-card elevation="1">
            <h4>Zapperfly build server 1.0.3</h4>

            <span class="joke">[[joke]]</span>
            <span class="date">[[time]]</span>

            <div class="config">
                <template is="dom-if" if="[[authenticated]]">
                    <iron-icon on-click="_configure" class="icon" icon="icons:settings"></iron-icon>
                </template>
                <template is="dom-if" if="[[!authenticated]]">
                    <iron-icon on-click="_loginDialog" class="icon" icon="icons:power-settings-new"></iron-icon>
                </template>
                <iron-icon on-click="_about" class="icon" icon="icons:info-outline"></iron-icon>
            </div>

        </paper-card>

        <paper-dialog id="about" with-backdrop>
            <a target="_blank" href="https://github.com/codingchili/zapperfly-asm"><img
                    style="position: absolute; top: 0; right: 0; border: 0;"
                    src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
                    alt="Fork me on GitHub"></a>
            <h2>About</h2>
            <paper-dialog-scrollable style="margin-top:64px;">

                <p>
                    Zapperfly-asm is a clustered build server with minimal setup!
                    Zapperfly is developed by Robin Duda, open source and available on github.
                </p>

                <hr>
                CHANGELOG
                <br>

                1.0.3
                <ul>
                    <li>login dialog and logout button.</li>
                    <li>role based access control: read/start/configure.</li>
                    <li>commandline to add new users to a running system.</li>
                    <li>allow cloning with ssh and using basic authentication in repo url.</li>
                    <li>added this changelog to the about dialog.</li>
                    <li>adjusted the size of buttons to be more appealing.</li>
                    <li>renamed the startup script from run -> zapperfly to avoid "run --start".</li>
                </ul>

                <hr>
                1.0.2
                <ul>
                    <li>now support for building in containers!</li>
                    <li>use a hazelcast queue to schedule builds over the cluster.</li>
                    <li>use a hazelcast list to store builds logs.</li>
                    <li>added input validation for build configuration.</li>
                    <li>split the queue list API from the build list API.</li>
                    <li>support newline in logs and improved grouping of log messages.</li>
                    <li>support building without passing the buildscript over the shell (uses a file for docker builds)</li>
                    <li>fixed - full build output was not captured.</li>
                </ul>
                <hr>
                1.0.1
                <ul>
                    <li>added a distributed hazelcast semaphore used when taking jobs from the queue.</li>
                    <li>mark all builds attached to an instance as failed if the owning instance goes down.</li>
                    <li>show executors cpu/memory usage and "last seen" when instance goes offline.</li>
                    <li>improved API latency worst case scenario from 250ms -> 5ms. (cluster routing)</li>
                    <li>added the ability to remove builds that are no longer running from history.</li>
                    <li>refactored the API into 'builds' and 'configuration'.</li>
                    <li>improved the UI, new color theme, various fixes and improvements including mobile/PWA</li>
                    <li>fixed an issue with autoclean not deleting readonly files: now adds write before deleting.</li>
                    <li>fixed styling issues with paper-input and black text.</li>
                    <li>fixed styling issues with paper-dialogs, the build log and checkboxes..</li>
                </ul>
                <hr>
                1.0.0
                <ul>
                    <li>schedule builds across the cluster (clone + build)</li>
                    <li>website (run with --website param) and API.</li>
                    <li>real-time logging output on the website.</li>
                    <li>support for setting instance capacity and name.</li>
                    <li>support for grouping instances with --group parameter.</li>
                    <li>configure builds by git repository url and branches.</li>
                    <li>clustered build data and logs.</li>
                    <li>full mobile support and may be added to homescreen as a progressive web app.</li>
                </ul>

            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button raised dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="login" with-backdrop>
            <h2>Login</h2>
            <paper-dialog-scrollable>

                <paper-input-container>
                    <label slot="label">username</label>
                    <iron-input slot="input" on-keydown="_submitLogin" bind-value="{{username}}">
                        <input autofocus>
                    </iron-input>
                </paper-input-container>

                <paper-input-container>
                    <label slot="label">password</label>
                    <iron-input slot="input" on-keydown="_submitLogin" bind-value="{{password}}">
                        <input type="password">
                    </iron-input>
                </paper-input-container>

            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button raised on-click="_login">Login</paper-button>
            </div>
        </paper-dialog>


        <paper-dialog id="configure" with-backdrop>
            <iron-icon on-click="_logout" class="icon" icon="icons:power-settings-new"></iron-icon>
            <h2>Configuration</h2>
            <paper-dialog-scrollable>

                <span style="opacity:0.45">cluster-wide settings.</span>

                <table id="config">
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td>User name</td>
                        <td>[[user]]</td>
                    </tr>
                    <tr>
                        <td>User role</td>
                        <td>[[role]]</td>
                    </tr>
                    <tr>
                        <td>Cluster group</td>
                        <td>[[config.groupName]]</td>
                    </tr>
                    <tr>
                        <td>Webserver host</td>
                        <td>[[config.instanceName]]</td>
                    </tr>
                    <tr>
                        <td>Build timeout</td>
                        <td>[[config.timeoutSeconds]] seconds.</td>
                    </tr>
                    <tr>
                        <td>Build path</td>
                        <td>[[config.buildPath]]</td>
                    </tr>
                </table>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button raised dialog-dismiss>Close</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax auto id="jokeLoader" url="https://api.icndb.com/jokes/random?limitTo=[nerdy]" handle-as="json"
                   on-response="_onJokes">
        </iron-ajax>

        <iron-ajax id="configLoader" method="post" url="/api/" handle-as="json"
                   on-response="_onConfig" debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="loginRequest"
                   url="/api/?target=authentication&route=login&username=[[username]]&password=[[password]]"
                   handle-as="json"
                   on-response="_onLogin">
        </iron-ajax>

        <paper-toast id="toast" text="[[errorText]]"></paper-toast>

    </template>
</dom-module>
<script>
    class BuildStats extends Polymer.Element {

        static get is() {
            return 'build-stats';
        }

        constructor() {
            super();

            this.username = '';
            this.password = '';
            this.authenticated = false;

            this._updateTime();
            setInterval(() => {
                this._updateTime();
            }, 1000);

            setInterval(() => {
                this.$.jokeLoader.generateRequest();
            }, 10000);
        }

        _about() {
            this.$.about.open();
        }

        _logout() {
            this.authenticated = false;
            this.$.configure.close();
            application.logout();
        }

        _loginDialog() {
            this.$.login.open();
        }

        _login() {
            this.$.loginRequest.generateRequest();
        }

        _submitLogin(e) {
            console.log(e);
            if (e.keyCode === 13) {
                this._login();
            }
        }

        _onLogin(event, request) {
            if (request.response.status === ACCEPTED) {
                application.authenticated(request.response);
                this.authenticated = true;
                this.user = application.token.domain;
                this.role = application.token.properties['role'];
                this.$.login.close();
            } else {
                this.password = '';
                this.errorText = request.response.message;
                this.$.toast.open();
            }
        }

        _configure() {
            this.$.configLoader.body = JSON.stringify({
                token: application.token,
                target: 'config',
                route: 'cluster'
            });
            this.$.configLoader.generateRequest();
            this.$.configure.open();
        }

        _updateTime() {
            this.time = new Date().toLocaleString();
        }

        _onJokes(event, request) {
            this.joke = request.response.value.joke;
        }

        _onConfig(event, request) {
            this.config = request.response;
        }
    }

    window.customElements.define(BuildStats.is, BuildStats);


</script>
